pipeline {
    agent any
    
    environment {
        AWS_REGION = 'us-east-1'
        AWS_ACCOUNT_ID = '833371734412'
        ECR_REGISTRY = '833371734412.dkr.ecr.us-east-1.amazonaws.com'
        ECR_REPOSITORY = 'nginx-web-site'
        
        // Terraform variables
        TF_VAR_aws_region = 'us-east-1'
        TF_VAR_environment = 'dev'
        TF_VAR_project_name = 'nginx-web-site'
        TF_VAR_aws_account_id = '833371734412'
    }

    stages {
        stage('‚ö†Ô∏è CONFIRMA√á√ÉO DE DESTRUI√á√ÉO') {
            steps {
                script {
                    echo "üö® ATEN√á√ÉO: Este pipeline ir√° DESTRUIR toda a infraestrutura!"
                    echo "üìã Recursos que ser√£o removidos:"
                    echo "   ‚Ä¢ ECS Cluster: nginx-web-site-cluster"
                    echo "   ‚Ä¢ ECS Service: nginx-web-site-task-service-b2igefhw"
                    echo "   ‚Ä¢ ECR Repository: nginx-web-site (e todas as imagens)"
                    echo "   ‚Ä¢ IAM Roles: ecsTaskExecutionRole, ecsTaskRole"
                    echo "   ‚Ä¢ CloudWatch Logs: /ecs/nginx-web-site"
                    echo ""
                    echo "‚ö†Ô∏è  ESTA A√á√ÉO √â IRREVERS√çVEL!"
                    echo "‚ö†Ô∏è  TODOS OS DADOS SER√ÉO PERDIDOS!"
                    echo ""
                    
                    def userInput = input(
                        message: 'Tem certeza que deseja DESTRUIR toda a infraestrutura?',
                        parameters: [
                            choice(
                                name: 'CONFIRMACAO',
                                choices: ['N√ÉO - Cancelar', 'SIM - Destruir tudo'],
                                description: 'Confirme sua escolha'
                            ),
                            string(
                                name: 'CONFIRM_TEXT',
                                defaultValue: '',
                                description: 'Digite "DESTRUIR" para confirmar (case sensitive)'
                            )
                        ],
                        submitterParameter: 'APPROVER'
                    )
                    
                    if (userInput.CONFIRMACAO != 'SIM - Destruir tudo') {
                        error "‚ùå Destrui√ß√£o cancelada pelo usu√°rio"
                    }
                    
                    if (userInput.CONFIRM_TEXT != 'DESTRUIR') {
                        error "‚ùå Texto de confirma√ß√£o incorreto. Digite exatamente: DESTRUIR"
                    }
                    
                    echo "‚úÖ Confirma√ß√£o recebida de: ${userInput.APPROVER}"
                    echo "üöÄ Iniciando processo de destrui√ß√£o..."
                }
            }
        }
        
        stage('Checkout') {
            steps {
                echo "üì• Verificando arquivos do projeto..."
                sh 'ls -la'
                sh 'ls -la terraform/ || echo "Diret√≥rio terraform n√£o encontrado"'
            }
        }
        
        stage('Terraform Init') {
            steps {
                withCredentials([aws(credentialsId: 'aws-access-key', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    dir('terraform') {
                        sh '''
                            echo "üîß Inicializando Terraform..."
                            terraform --version
                            terraform init
                            echo "‚úÖ Terraform inicializado!"
                        '''
                    }
                }
            }
        }
        
        stage('Verificar Estado Atual') {
            steps {
                withCredentials([aws(credentialsId: 'aws-access-key', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    dir('terraform') {
                        sh '''
                            echo "üîç Verificando estado atual da infraestrutura..."
                            terraform refresh
                            echo ""
                            echo "üìä Recursos atuais:"
                            terraform show || echo "Nenhum recurso encontrado"
                            echo ""
                            echo "üìã Outputs atuais:"
                            terraform output || echo "Nenhum output encontrado"
                        '''
                    }
                }
            }
        }
        
        stage('Terraform Destroy Plan') {
            steps {
                withCredentials([aws(credentialsId: 'aws-access-key', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    dir('terraform') {
                        sh '''
                            echo "üìã Criando plano de destrui√ß√£o..."
                            terraform plan -destroy -out=destroy.tfplan
                            echo "‚úÖ Plano de destrui√ß√£o criado!"
                            echo ""
                            echo "üìù Recursos que ser√£o destru√≠dos est√£o listados acima"
                        '''
                    }
                }
            }
        }
        
        stage('üö® √öLTIMA CONFIRMA√á√ÉO') {
            steps {
                script {
                    echo "üõë √öLTIMA OPORTUNIDADE DE CANCELAR!"
                    echo "‚ö†Ô∏è  Ap√≥s este ponto, a destrui√ß√£o ser√° executada automaticamente"
                    echo ""
                    
                    input message: 'CONFIRMA√á√ÉO FINAL: Executar a destrui√ß√£o agora?', 
                          ok: 'üíÄ DESTRUIR AGORA',
                          submitterParameter: 'FINAL_APPROVER'
                    
                    echo "üíÄ Confirma√ß√£o final recebida de: ${env.FINAL_APPROVER}"
                    echo "üöÄ Iniciando destrui√ß√£o..."
                }
            }
        }
        
        stage('Limpar ECR Repository') {
            steps {
                withCredentials([aws(credentialsId: 'aws-access-key', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    sh '''
                        echo "üóëÔ∏è Limpando imagens do ECR..."
                        
                        # Verificar se o reposit√≥rio existe
                        if aws ecr describe-repositories --repository-names ${ECR_REPOSITORY} --region ${AWS_REGION} >/dev/null 2>&1; then
                            echo "üì¶ Reposit√≥rio ECR encontrado, listando imagens..."
                            
                            # Listar e deletar todas as imagens
                            IMAGE_IDS=$(aws ecr list-images --repository-name ${ECR_REPOSITORY} --region ${AWS_REGION} --query 'imageIds[*]' --output json)
                            
                            if [ "$IMAGE_IDS" != "[]" ]; then
                                echo "üóÇÔ∏è Imagens encontradas, removendo..."
                                aws ecr batch-delete-image --repository-name ${ECR_REPOSITORY} --region ${AWS_REGION} --image-ids "$IMAGE_IDS"
                                echo "‚úÖ Imagens removidas do ECR"
                            else
                                echo "üì≠ Nenhuma imagem encontrada no reposit√≥rio"
                            fi
                        else
                            echo "üì≠ Reposit√≥rio ECR n√£o encontrado ou j√° removido"
                        fi
                    '''
                }
            }
        }
        
        stage('Terraform Destroy') {
            steps {
                withCredentials([aws(credentialsId: 'aws-access-key', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    dir('terraform') {
                        sh '''
                            echo "üí• Executando destrui√ß√£o da infraestrutura..."
                            echo "‚è≥ Este processo pode demorar alguns minutos..."
                            
                            terraform apply destroy.tfplan
                            
                            echo "‚úÖ Destrui√ß√£o conclu√≠da!"
                            echo ""
                            echo "üîç Verificando se ainda existem recursos..."
                            terraform show || echo "‚úÖ Nenhum recurso restante - destrui√ß√£o completa!"
                        '''
                    }
                }
            }
        }
        
        stage('Verifica√ß√£o Final') {
            steps {
                withCredentials([aws(credentialsId: 'aws-access-key', accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY')]) {
                    sh '''
                        echo "üîç Verifica√ß√£o final dos recursos AWS..."
                        echo ""
                        
                        echo "üìã Verificando ECS Clusters:"
                        aws ecs list-clusters --region ${AWS_REGION} --query 'clusterArns[?contains(@, `nginx-web-site`)]' || echo "Nenhum cluster encontrado"
                        echo ""
                        
                        echo "üìã Verificando ECR Repositories:"
                        aws ecr describe-repositories --repository-names ${ECR_REPOSITORY} --region ${AWS_REGION} 2>/dev/null || echo "‚úÖ Reposit√≥rio ECR removido"
                        echo ""
                        
                        echo "üìã Verificando IAM Roles:"
                        aws iam get-role --role-name ecsTaskExecutionRole 2>/dev/null || echo "‚úÖ Role ecsTaskExecutionRole removido"
                        aws iam get-role --role-name ecsTaskRole 2>/dev/null || echo "‚úÖ Role ecsTaskRole removido"
                        echo ""
                        
                        echo "üìã Verificando CloudWatch Log Groups:"
                        aws logs describe-log-groups --log-group-name-prefix "/ecs/nginx-web-site" --region ${AWS_REGION} --query 'logGroups[*].logGroupName' 2>/dev/null || echo "‚úÖ Log groups removidos"
                        echo ""
                        
                        echo "üéâ DESTRUI√á√ÉO COMPLETA!"
                        echo "‚úÖ Todos os recursos foram removidos com sucesso"
                        echo "üí∞ Custos AWS interrompidos"
                        echo ""
                        echo "üìù Para recriar a infraestrutura, execute o pipeline principal"
                    '''
                }
            }
        }
    }
    
    post {
        success { 
            echo "üéâ DESTRUI√á√ÉO EXECUTADA COM SUCESSO!"
            echo "‚úÖ Todos os recursos AWS foram removidos"
            echo "üí∞ Custos interrompidos"
            echo ""
            echo "üìã Resumo:"
            echo "   ‚Ä¢ ECS Cluster: ‚ùå Removido"
            echo "   ‚Ä¢ ECS Service: ‚ùå Removido" 
            echo "   ‚Ä¢ ECR Repository: ‚ùå Removido"
            echo "   ‚Ä¢ IAM Roles: ‚ùå Removidos"
            echo "   ‚Ä¢ CloudWatch Logs: ‚ùå Removidos"
            echo ""
            echo "üîÑ Para recriar, execute o pipeline de deploy principal"
        }
        failure { 
            echo "‚ùå FALHA NA DESTRUI√á√ÉO!"
            echo "‚ö†Ô∏è  Alguns recursos podem ainda existir na AWS"
            echo "üîç Verifique manualmente no console AWS:"
            echo "   ‚Ä¢ ECS: https://console.aws.amazon.com/ecs/"
            echo "   ‚Ä¢ ECR: https://console.aws.amazon.com/ecr/"
            echo "   ‚Ä¢ IAM: https://console.aws.amazon.com/iam/"
            echo "   ‚Ä¢ CloudWatch: https://console.aws.amazon.com/cloudwatch/"
            echo ""
            echo "üí° Execute o pipeline novamente ou remova manualmente"
        }
        cleanup {
            sh '''
                echo "üßπ Limpando arquivos tempor√°rios..."
                rm -f terraform/destroy.tfplan || true
                echo "‚úÖ Limpeza conclu√≠da"
            '''
        }
    }
}